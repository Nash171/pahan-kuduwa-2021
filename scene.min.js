const canvas=document.getElementById("renderCanvas");const engine=new BABYLON.Engine(canvas,true);const main_lanterns=[];const all_lanterns=[];const all_meshes=[];const frameRate=60;const createScene=function(){const a=new BABYLON.Scene(engine);a.clearColor=BABYLON.Color3.Black();a.collisionsEnabled=true;const e=new BABYLON.UniversalCamera("UniversalCamera",new BABYLON.Vector3(0,40,600),a);e.setTarget(new BABYLON.Vector3(0,200,0));e.inputs.addMouseWheel();e.attachControl(canvas,true);e.checkCollisions=true;const t=new BABYLON.MeshBuilder.CreateCylinder("container",{height:500,diameter:1500,sideOrientation:1},a);t.position.y=250;t.checkCollisions=true;const r=createLantern(a,"Lantern1",{r1:8,r2:64,h1:8,h2:8,speed:0,order:0},"Lantern-1");main_lanterns.push(r);const n=createLantern(a,"Lantern2",{r1:8,r2:32,h1:8,h2:8,speed:1,order:1},"Lantern-2");main_lanterns.push(n);const o=createLantern(a,"Lantern3",{r1:8,r2:8,h1:0,h2:10,speed:-1,order:2},"Lantern-3-4-6-7");main_lanterns.push(o);const s={r1:8,r2:20,h1:12,h2:20,speed:1,order:3};const l=createLantern(a,"bottomGrp_main",s,"Grp-bottom-main");main_lanterns.push(l);createSubLanterns(a,l.outerLayer,"bottomGrp",2,s,6,"Grp",9);const u=createLantern(a,"Lantern4",{r1:8,r2:8,h1:0,h2:10,speed:1,order:3},"Lantern-3-4-6-7");main_lanterns.push(u);const m=createLantern(a,"Lantern5",{r1:8,r2:48,h1:8,h2:8,speed:-1,order:4},"Lantern-5");main_lanterns.push(m);const i=createLantern(a,"Lantern6",{r1:8,r2:8,h1:0,h2:10,speed:1,order:5},"Lantern-3-4-6-7");main_lanterns.push(i);const c={r1:8,r2:32,h1:16,h2:32,speed:-1,order:6};const h=createLantern(a,"topGrp_main",c,"Grp-top-main");main_lanterns.push(h);createSubLanterns(a,h.outerLayer,"topGrp",2,c,6,"Grp",11);const p=createLantern(a,"Lantern7",{r1:8,r2:8,h1:0,h2:10,speed:-1,order:6},"Lantern-3-4-6-7");main_lanterns.push(p);const f=createLantern(a,"Lantern8",{r1:8,r2:110,h1:8,h2:8,speed:1,order:7},"Lantern-8");main_lanterns.push(f);const L=createLantern(a,"Lantern9",{r1:8,r2:220,h1:0,h2:16,speed:1,order:8},"Lantern-9");main_lanterns.push(L);stackLanterns(main_lanterns);const B=new BABYLON.GlowLayer("glow",a);B.intensity=.8;for(let e=0;e<all_lanterns.length;e++){if(all_lanterns[e].options.speed!=0){a.beginDirectAnimation(all_lanterns[e].outerLayer,[rotateLantern(all_lanterns[e].options.speed)],0,30*frameRate,true)}}for(let e=0;e<all_meshes.length;e++){a.beginDirectAnimation(all_meshes[e].lightLayer,[changeColor(all_meshes[e])],0,90*frameRate,true);all_meshes[e].outerLayer.material.emissiveColor=new BABYLON.Color3(.02,.02,.02)}animateCamera(a,e);return a};const animateCamera=(e,a)=>{const t=new BABYLON.Animation("movein","position",frameRate,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);const r=[];r.push({frame:0,value:a.position.clone()});r.push({frame:5*frameRate,value:a.position.clone()});r.push({frame:11*frameRate,value:new BABYLON.Vector3(0,40,150)});r.push({frame:13*frameRate,value:new BABYLON.Vector3(0,40,120)});r.push({frame:21*frameRate,value:new BABYLON.Vector3(0,40,320)});t.setKeys(r);const n=new BABYLON.Animation("rotate","rotation.x",frameRate,BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);const o=[];o.push({frame:0,value:-Math.PI/12});o.push({frame:5*frameRate,value:-Math.PI/12});o.push({frame:11*frameRate,value:-Math.PI/10});o.push({frame:13*frameRate,value:Math.PI/16});o.push({frame:21*frameRate,value:-Math.PI/4});o.push({frame:25*frameRate,value:-Math.PI/12});n.setKeys(o);e.beginDirectAnimation(a,[t,n],0,25*frameRate,false)};const createLantern=(e,a,t,r)=>{const n=new BABYLON.Mesh(a,e);const{r1:o,r2:s,h1:l,h2:u}=t;const m=6;const i=[o,s,s,o];const c=-(l+u+l)/2;const h=[c,c+l,c+l+u,c+l+u+l];const p=2*Math.PI/m;let f=[];for(let e=0;e<h.length;e++){const _=h[e];const I=i[e];for(let e=0;e<m;e++){f.push(I*Math.cos(e*p),_,I*Math.sin(e*p))}}let L=[];for(let e=0;e<3;e++){const x=e*m;for(let e=0;e<m;e++){L.push(x+e,x+(e+1)%m,x+e+m);L.push(x+(e+1)%m+m,x+e+m,x+(e+1)%m)}}const B=(s-o)/2;const d=Math.sqrt(l**2+3*(s-o)**2/4);const A=s;const v=d*2+u;const O=B/A;const R=(s-B)/A;const N=d/v;const w=(d+u)/v;const Y=[O,0,R,0,O,0,R,0,O,0,R,0,0,N,1,N,0,N,1,N,0,N,1,N,0,w,1,w,0,w,1,w,0,w,1,w,O,1,R,1,O,1,R,1,O,1,R,1];const M=[];const g=new BABYLON.VertexData;BABYLON.VertexData.ComputeNormals(f,L,M);g.positions=f;g.indices=L;g.normals=M;g.uvs=Y;g.applyToMesh(n);const b=new BABYLON.StandardMaterial("outerMaterial",e);b.diffuseTexture=new BABYLON.Texture(r?`./texture/${r}.png`:generateImage(a,A*10,v*10,B*10,(s-B)*10,d*10,(d+u)*10),e);b.diffuseTexture.hasAlpha=true;n.material=b;const T=new BABYLON.StandardMaterial("innerMaterial",e);T.emissiveColor=new BABYLON.Color3(.5,0,0);const y=n.clone(`${a}-lightLayer`);y.scaling=new BABYLON.Vector3(.995,.995,.995);y.material=T;y.parent=n;const C={outerLayer:n,options:t,lightLayer:y};all_lanterns.push(C);all_meshes.push(C);return C};const createSubLanterns=(a,t,r,n,o,s,l,u)=>{const m={r1:0,r2:o.r2/2,h1:o.h1/2,h2:o.h2/2,speed:o.speed*-3,order:u};const i=2*Math.PI/s;for(let e=0;e<s;e++){const c=`${r}-${e}`;const h=createLantern(a,c,m,`${l}-${n}`);h.outerLayer.parent=t;const p=n==1?m.r2*6:m.r2*8;h.outerLayer.position=new BABYLON.Vector3(p*Math.cos(e*i),0,p*Math.sin(e*i));const f=[new BABYLON.Vector3(0,o.r2,0),new BABYLON.Vector3(0,n>1?o.h1+o.h2/2+5:o.r2+1,0),new BABYLON.Vector3(p*Math.cos(e*i),m.r2+1,p*Math.sin(e*i)),new BABYLON.Vector3(p*Math.cos(e*i),m.r2-2,p*Math.sin(e*i))];const L=BABYLON.MeshBuilder.CreateTube(`${c}-tube`,{path:f,radius:n/2,tesselation:8,sideOrientation:BABYLON.Mesh.DOUBLESIDE},a);const B=new BABYLON.StandardMaterial("tubeMaterial",a);B.diffuseTexture=new BABYLON.Texture(`./texture/Tube.png`,a);B.diffuseTexture.hasAlpha=true;L.material=B;const d=new BABYLON.StandardMaterial("tubeInnerMaterial",a);d.emissiveColor=new BABYLON.Color3(.5,0,0);const A=BABYLON.MeshBuilder.CreateTube(`${c}-tube-lightLayer`,{path:f,radius:n/2-.1,sideOrientation:BABYLON.Mesh.DOUBLESIDE},a);A.material=d;A.parent=L;all_meshes.push({outerLayer:L,options:{order:u},lightLayer:A});L.parent=t;if(n-1){createSubLanterns(a,h.outerLayer,c,n-1,m,s,l,u+1)}}};const rotateLantern=e=>{const a=new BABYLON.Animation("rotateLantern","rotation.y",frameRate,BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);const t=[];t.push({frame:0,value:0});t.push({frame:15*frameRate,value:e*Math.PI});t.push({frame:30*frameRate,value:e*2*Math.PI});a.setKeys(t);return a};const red=new BABYLON.Color3(.5,0,0);const yellow=new BABYLON.Color3(.5,.5,0);const green=new BABYLON.Color3(0,.5,0);const blue=new BABYLON.Color3(0,.2,.8);const purple=new BABYLON.Color3(.5,0,.8);const white=new BABYLON.Color3(.5,.5,.5);const black=new BABYLON.Color3(0,0,0);const changeColor=e=>{const a=new BABYLON.Animation("rotateLantern","material.emissiveColor",frameRate,BABYLON.Animation.ANIMATIONTYPE_COLOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);const t=[];t.push({frame:0,value:red});t.push({frame:5*frameRate-1,value:red});t.push({frame:5*frameRate,value:yellow});t.push({frame:10*frameRate-1,value:yellow});t.push({frame:10*frameRate,value:green});t.push({frame:15*frameRate-1,value:green});t.push({frame:15*frameRate,value:blue});t.push({frame:20*frameRate-1,value:blue});t.push({frame:20*frameRate,value:purple});t.push({frame:25*frameRate-1,value:purple});t.push({frame:25*frameRate,value:white});t.push({frame:30*frameRate-1,value:white});t.push({frame:30*frameRate,value:red});t.push({frame:31*frameRate-1,value:red});t.push({frame:31*frameRate,value:yellow});t.push({frame:32*frameRate-1,value:yellow});t.push({frame:32*frameRate,value:green});t.push({frame:33*frameRate-1,value:green});t.push({frame:33*frameRate,value:blue});t.push({frame:34*frameRate-1,value:blue});t.push({frame:34*frameRate,value:purple});t.push({frame:35*frameRate-1,value:purple});t.push({frame:35*frameRate,value:white});t.push({frame:36*frameRate-1,value:white});t.push({frame:36*frameRate,value:red});t.push({frame:38*frameRate,value:yellow});t.push({frame:40*frameRate,value:green});t.push({frame:42*frameRate,value:blue});t.push({frame:44*frameRate,value:purple});t.push({frame:46*frameRate,value:white});t.push({frame:48*frameRate,value:black});const r=6;t.push({frame:(50+e.options.order/r)*frameRate-1,value:black});t.push({frame:(50+e.options.order/r)*frameRate,value:red});t.push({frame:54*frameRate-1,value:red});t.push({frame:54*frameRate,value:black});t.push({frame:(55+e.options.order/r)*frameRate-1,value:black});t.push({frame:(55+e.options.order/r)*frameRate,value:yellow});t.push({frame:59*frameRate-1,value:yellow});t.push({frame:59*frameRate,value:black});t.push({frame:(60+e.options.order/r)*frameRate-1,value:black});t.push({frame:(60+e.options.order/r)*frameRate,value:green});t.push({frame:64*frameRate-1,value:green});t.push({frame:64*frameRate,value:black});t.push({frame:(65+e.options.order/r)*frameRate-1,value:black});t.push({frame:(65+e.options.order/r)*frameRate,value:blue});t.push({frame:69*frameRate-1,value:blue});t.push({frame:69*frameRate,value:black});t.push({frame:(70+e.options.order/r)*frameRate-1,value:black});t.push({frame:(70+e.options.order/r)*frameRate,value:purple});t.push({frame:74*frameRate-1,value:purple});t.push({frame:74*frameRate,value:black});t.push({frame:(75+e.options.order/r)*frameRate-1,value:black});t.push({frame:(75+e.options.order/r)*frameRate,value:white});t.push({frame:(79+e.options.order/r)*frameRate-1,value:white});t.push({frame:(79+e.options.order/r)*frameRate,value:black});t.push({frame:90*frameRate,value:black});a.setKeys(t);return a};const stackLanterns=a=>{let t=0;for(let e=0;e<a.length;e++){const r=a[e].outerLayer.getBoundingInfo();t+=-r.minimum.y;a[e].outerLayer.position.y=t;t+=r.maximum.y}};const generateImage=(e,a,t,r,n,o,s)=>{const l=document.createElement("canvas");l.width=a;l.height=t;ctx=l.getContext("2d");ctx.strokeStyle="white";ctx.lineWidth=16;ctx.beginPath();ctx.moveTo(r,0);ctx.lineTo(0,o);ctx.lineTo(0,s);ctx.lineTo(r,t);ctx.lineTo(n,t);ctx.lineTo(a,s);ctx.lineTo(a,o);ctx.lineTo(n,0);ctx.lineTo(r,0);ctx.fillStyle="red";ctx.moveTo(0,o);ctx.lineTo(a,o);ctx.moveTo(0,s);ctx.lineTo(a,s);ctx.stroke();const u=l.toDataURL();return u};const downloadImage=(e,a)=>{const t=document.createElement("a");t.href=a;t.download=`${e}.png`;document.body.appendChild(t);t.click();document.body.removeChild(t)};const scene=createScene();engine.runRenderLoop(function(){scene.render()});window.addEventListener("resize",function(){engine.resize()});