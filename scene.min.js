const canvas=document.getElementById("renderCanvas");const engine=new BABYLON.Engine(canvas,true);const main_lanterns=[];const all_lanterns=[];const all_meshes=[];const frameRate=30;const createScene=function(){const a=new BABYLON.Scene(engine);a.clearColor=BABYLON.Color3.Black();var e=new BABYLON.UniversalCamera("UniversalCamera",new BABYLON.Vector3(0,10,800),a);e.setTarget(new BABYLON.Vector3(0,150,0));e.inputs.addMouseWheel();e.attachControl(canvas,true);const r=createLantern(a,"Lantern1",{r1:8,r2:64,h1:8,h2:8,speed:0,order:0},"Lantern-1");main_lanterns.push(r);const t=createLantern(a,"Lantern2",{r1:8,r2:32,h1:8,h2:8,speed:1,order:1},"Lantern-2");main_lanterns.push(t);const n=createLantern(a,"Lantern3",{r1:8,r2:8,h1:0,h2:10,speed:-1,order:2},"Lantern-3-4-6-7");main_lanterns.push(n);const o={r1:8,r2:20,h1:12,h2:20,speed:1,order:3};const s=createLantern(a,"bottomGrp_main",o,"Grp-bottom-main");main_lanterns.push(s);createSubLanterns(a,s.outerLayer,"bottomGrp",2,o,6,"Grp",11);const l=createLantern(a,"Lantern4",{r1:8,r2:8,h1:0,h2:10,speed:1,order:3},"Lantern-3-4-6-7");main_lanterns.push(l);const u=createLantern(a,"Lantern5",{r1:8,r2:48,h1:8,h2:8,speed:-1,order:4},"Lantern-5");main_lanterns.push(u);const m=createLantern(a,"Lantern6",{r1:8,r2:8,h1:0,h2:10,speed:1,order:5},"Lantern-3-4-6-7");main_lanterns.push(m);const c={r1:8,r2:32,h1:16,h2:32,speed:-1,order:6};const i=createLantern(a,"topGrp_main",c,"Grp-top-main");main_lanterns.push(i);createSubLanterns(a,i.outerLayer,"topGrp",2,c,6,"Grp",15);const h=createLantern(a,"Lantern7",{r1:8,r2:8,h1:0,h2:10,speed:-1,order:6},"Lantern-3-4-6-7");main_lanterns.push(h);const p=createLantern(a,"Lantern8",{r1:8,r2:110,h1:8,h2:8,speed:1,order:7},"Lantern-8");main_lanterns.push(p);const f=createLantern(a,"Lantern9",{r1:8,r2:220,h1:0,h2:16,speed:1,order:8},"Lantern-9");main_lanterns.push(f);stackLanterns(main_lanterns);const L=new BABYLON.GlowLayer("glow",a);L.intensity=.8;for(let e=0;e<all_lanterns.length;e++){if(all_lanterns[e].options.speed!=0){a.beginDirectAnimation(all_lanterns[e].outerLayer,[rotateLantern(all_lanterns[e].options.speed)],0,30*frameRate,true)}}for(let e=0;e<all_meshes.length;e++){a.beginDirectAnimation(all_meshes[e].lightLayer,[changeColor(all_meshes[e])],0,90*frameRate,true);all_meshes[e].outerLayer.material.emissiveColor=new BABYLON.Color3(.02,.02,.02)}return a};const createLantern=(e,a,r,t)=>{const n=new BABYLON.Mesh(a,e);const{r1:o,r2:s,h1:l,h2:u}=r;const m=6;const c=[o,s,s,o];const i=-(l+u+l)/2;const h=[i,i+l,i+l+u,i+l+u+l];const p=2*Math.PI/m;let f=[];for(let e=0;e<h.length;e++){const x=h[e];const T=c[e];for(let e=0;e<m;e++){f.push(T*Math.cos(e*p),x,T*Math.sin(e*p))}}let L=[];for(let e=0;e<3;e++){const I=e*m;for(let e=0;e<m;e++){L.push(I+e,I+(e+1)%m,I+e+m);L.push(I+(e+1)%m+m,I+e+m,I+(e+1)%m)}}const d=(s-o)/2;const B=Math.sqrt(l**2+3*(s-o)**2/4);const v=s;const A=B*2+u;const O=d/v;const w=(s-d)/v;const R=B/A;const N=(B+u)/A;const Y=[O,0,w,0,O,0,w,0,O,0,w,0,0,R,1,R,0,R,1,R,0,R,1,R,0,N,1,N,0,N,1,N,0,N,1,N,O,1,w,1,O,1,w,1,O,1,w,1];const g=[];const y=new BABYLON.VertexData;BABYLON.VertexData.ComputeNormals(f,L,g);y.positions=f;y.indices=L;y.normals=g;y.uvs=Y;y.applyToMesh(n);const M=new BABYLON.StandardMaterial("outerMaterial",e);M.diffuseTexture=new BABYLON.Texture(t?`./texture/${t}.png`:generateImage(a,v*10,A*10,d*10,(s-d)*10,B*10,(B+u)*10),e);M.diffuseTexture.hasAlpha=true;n.material=M;const C=new BABYLON.StandardMaterial("innerMaterial",e);C.emissiveColor=new BABYLON.Color3(.5,0,0);const b=n.clone(`${a}-lightLayer`);b.scaling=new BABYLON.Vector3(.995,.995,.995);b.material=C;b.parent=n;const _={outerLayer:n,options:r,lightLayer:b};all_lanterns.push(_);all_meshes.push(_);return _};const createSubLanterns=(a,r,t,n,o,s,l,u)=>{const m={r1:0,r2:o.r2/2,h1:o.h1/2,h2:o.h2/2,speed:o.speed*-2,order:u};const c=2*Math.PI/s;for(let e=0;e<s;e++){const i=`${t}-${e}`;const h=createLantern(a,i,m,`${l}-${n}`);h.outerLayer.parent=r;const p=n==1?m.r2*6:m.r2*8;h.outerLayer.position=new BABYLON.Vector3(p*Math.cos(e*c),0,p*Math.sin(e*c));const f=[new BABYLON.Vector3(0,o.r2,0),new BABYLON.Vector3(0,n>1?o.h1+o.h2/2+5:o.r2+1,0),new BABYLON.Vector3(p*Math.cos(e*c),m.r2+1,p*Math.sin(e*c)),new BABYLON.Vector3(p*Math.cos(e*c),m.r2-2,p*Math.sin(e*c))];const L=BABYLON.MeshBuilder.CreateTube(`${i}-tube`,{path:f,radius:n/2,tesselation:8,sideOrientation:BABYLON.Mesh.DOUBLESIDE},a);const d=new BABYLON.StandardMaterial("tubeMaterial",a);d.diffuseTexture=new BABYLON.Texture(`./texture/Tube.png`,a);d.diffuseTexture.hasAlpha=true;L.material=d;const B=new BABYLON.StandardMaterial("tubeInnerMaterial",a);B.emissiveColor=new BABYLON.Color3(.5,0,0);const v=BABYLON.MeshBuilder.CreateTube(`${i}-tube-lightLayer`,{path:f,radius:n/2-.1,sideOrientation:BABYLON.Mesh.DOUBLESIDE},a);v.material=B;v.parent=L;all_meshes.push({outerLayer:L,options:{order:u-1},lightLayer:v});L.parent=r;if(n-1){createSubLanterns(a,h.outerLayer,i,n-1,m,s,l,u+2)}}};const rotateLantern=e=>{const a=new BABYLON.Animation("rotateLantern","rotation.y",frameRate,BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);const r=[];r.push({frame:0,value:0});r.push({frame:15*frameRate,value:e*Math.PI});r.push({frame:30*frameRate,value:e*2*Math.PI});a.setKeys(r);return a};const red=new BABYLON.Color3(.5,0,0);const yellow=new BABYLON.Color3(.5,.5,0);const green=new BABYLON.Color3(0,.5,0);const blue=new BABYLON.Color3(0,.2,.8);const purple=new BABYLON.Color3(.5,0,.8);const white=new BABYLON.Color3(.5,.5,.5);const black=new BABYLON.Color3(0,0,0);const changeColor=e=>{const a=new BABYLON.Animation("rotateLantern","material.emissiveColor",frameRate,BABYLON.Animation.ANIMATIONTYPE_COLOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);const r=[];r.push({frame:0,value:red});r.push({frame:5*frameRate-1,value:red});r.push({frame:5*frameRate,value:yellow});r.push({frame:10*frameRate-1,value:yellow});r.push({frame:10*frameRate,value:green});r.push({frame:15*frameRate-1,value:green});r.push({frame:15*frameRate,value:blue});r.push({frame:20*frameRate-1,value:blue});r.push({frame:20*frameRate,value:purple});r.push({frame:25*frameRate-1,value:purple});r.push({frame:25*frameRate,value:white});r.push({frame:30*frameRate-1,value:white});r.push({frame:30*frameRate,value:red});r.push({frame:31*frameRate-1,value:red});r.push({frame:31*frameRate,value:yellow});r.push({frame:32*frameRate-1,value:yellow});r.push({frame:32*frameRate,value:green});r.push({frame:33*frameRate-1,value:green});r.push({frame:33*frameRate,value:blue});r.push({frame:34*frameRate-1,value:blue});r.push({frame:34*frameRate,value:purple});r.push({frame:35*frameRate-1,value:purple});r.push({frame:35*frameRate,value:white});r.push({frame:36*frameRate-1,value:white});r.push({frame:36*frameRate,value:red});r.push({frame:38*frameRate,value:yellow});r.push({frame:40*frameRate,value:green});r.push({frame:42*frameRate,value:blue});r.push({frame:44*frameRate,value:purple});r.push({frame:46*frameRate,value:white});r.push({frame:48*frameRate,value:black});r.push({frame:(50+e.options.order/5)*frameRate-1,value:black});r.push({frame:(50+e.options.order/5)*frameRate,value:red});r.push({frame:(55+e.options.order/5)*frameRate-1,value:red});r.push({frame:(55+e.options.order/5)*frameRate,value:yellow});r.push({frame:(60+e.options.order/5)*frameRate-1,value:yellow});r.push({frame:(60+e.options.order/5)*frameRate,value:green});r.push({frame:(65+e.options.order/5)*frameRate-1,value:green});r.push({frame:(65+e.options.order/5)*frameRate,value:blue});r.push({frame:(70+e.options.order/5)*frameRate-1,value:blue});r.push({frame:(70+e.options.order/5)*frameRate,value:purple});r.push({frame:(75+e.options.order/5)*frameRate-1,value:purple});r.push({frame:(75+e.options.order/5)*frameRate,value:white});r.push({frame:(80+e.options.order/5)*frameRate-1,value:white});r.push({frame:(80+e.options.order/5)*frameRate,value:black});r.push({frame:90*frameRate,value:black});a.setKeys(r);return a};const stackLanterns=a=>{let r=0;for(let e=0;e<a.length;e++){const t=a[e].outerLayer.getBoundingInfo();r+=-t.minimum.y;a[e].outerLayer.position.y=r;r+=t.maximum.y}};const generateImage=(e,a,r,t,n,o,s)=>{const l=document.createElement("canvas");l.width=a;l.height=r;ctx=l.getContext("2d");ctx.strokeStyle="white";ctx.lineWidth=16;ctx.beginPath();ctx.moveTo(t,0);ctx.lineTo(0,o);ctx.lineTo(0,s);ctx.lineTo(t,r);ctx.lineTo(n,r);ctx.lineTo(a,s);ctx.lineTo(a,o);ctx.lineTo(n,0);ctx.lineTo(t,0);ctx.fillStyle="red";ctx.moveTo(0,o);ctx.lineTo(a,o);ctx.moveTo(0,s);ctx.lineTo(a,s);ctx.stroke();const u=l.toDataURL();return u};const downloadImage=(e,a)=>{var r=document.createElement("a");r.href=a;r.download=`${e}.png`;document.body.appendChild(r);r.click();document.body.removeChild(r)};const scene=createScene();engine.runRenderLoop(function(){scene.render()});window.addEventListener("resize",function(){engine.resize()});